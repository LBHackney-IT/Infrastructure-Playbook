<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/Infrastructure-Playbook/blog/rss.xml" title="Hackney Infrastructure Playbook Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Infrastructure-Playbook/blog/atom.xml" title="Hackney Infrastructure Playbook Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Hackney Infrastructure Playbook" href="/Infrastructure-Playbook/opensearch.xml"><title data-react-helmet="true">Infrastucture as Code | Hackney Infrastructure Playbook</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Infrastucture as Code | Hackney Infrastructure Playbook"><meta data-react-helmet="true" name="description" content="What is Infrastucture as Code (IaC)?"><meta data-react-helmet="true" property="og:description" content="What is Infrastucture as Code (IaC)?"><meta data-react-helmet="true" property="og:url" content="https://lbhackney-it.github.io/Infrastructure-Playbook/Infrastructure-Playbook/infrastructure"><link data-react-helmet="true" rel="shortcut icon" href="/Infrastructure-Playbook/img/favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://lbhackney-it.github.io/Infrastructure-Playbook/Infrastructure-Playbook/infrastructure"><link rel="stylesheet" href="/Infrastructure-Playbook/styles.2116970b.css">
<link rel="stylesheet" href="/Infrastructure-Playbook/main.4a16e2e4.css">
<link rel="preload" href="/Infrastructure-Playbook/styles.7299e51b.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/runtime~main.58b5ab71.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/main.5b7a4e19.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/1.e9c46241.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/2.316fd6e7.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/65.f167685d.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/68.c087ac3c.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/935f2afb.7c354906.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/17896441.40891053.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/f1db5c92.a78ded2b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/Infrastructure-Playbook/"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Infrastructure Playbook</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/Infrastructure-Playbook/"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Infrastructure Playbook</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Infrastucture as Code</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-infrastucture-as-code-iac"></a>What is Infrastucture as Code (IaC)?<a class="hash-link" href="#what-is-infrastucture-as-code-iac" title="Direct link to heading">#</a></h2><p>Infrastructure as code is the approach used within HackIT to manage and provision cloud resources with the use of scripted configuration files. It allows for easy maintenance and creation of the different cloud resources for large scale systems in a collaborative manner.</p><p>When using infrastructure-as-code approach, any resources created have their state recorded within state files. Those files will be used by the tool used to manage the infrastructure as a comparison point whenever new resources are added or existing ones are amended.</p><p>IaC is important as it allows for cloud infrastructure to be provisioned in a quick manner and it provides a code reference for the resources created and the configuration used to do so.</p><p>For example, if a resource is accidentally terminated, the IaC can be used to re-provision that machine in exactly the configuration as before. Whereas, with manual provisioning, a developer would need to remember (or consult an external source for) the configuration of the resource, and then take the time to manually reconfigure that within the environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction-to-terraform"></a>Introduction to Terraform<a class="hash-link" href="#introduction-to-terraform" title="Direct link to heading">#</a></h2><p>We use Terraform as our infrastructure-as-code tool - it is provider agnostic and makes use of HashiCorp Configuration Language (HCL).</p><p>For more details, please read our <a href="https://docs.google.com/document/d/1Wwj0HTBuSPjQ0ym9dtnGc7pM4x4cfA7OsAbr4YVnsWI/edit?usp=sharing" target="_blank" rel="noopener noreferrer">HackIT Terraform Guide</a>, containing all details of what Terraform is, how to use it, how we use Terraform and how to use our Terraform templates, including deployment steps:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="video-tutorial"></a>Video Tutorial<a class="hash-link" href="#video-tutorial" title="Direct link to heading">#</a></h3><p><strong> Watch our introduction video for more insight into the basics of Terraform: </strong></p><figure class="video-container"><iframe width="100" src="https://www.youtube.com/embed/sGbjWgSTpnY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-a-terraform-state-file"></a>What is a Terraform state file?<a class="hash-link" href="#what-is-a-terraform-state-file" title="Direct link to heading">#</a></h3><p>A Terraform state file stores the state of the infrastructure at the point of you applying it - this is the way Terraform knows what resources were created (via the given Terraform configuration). When an update to a resource has happened, Terraform will detect the difference between the state and the update and will change the resource (if you perform the ‚Äúapply‚Äù action).</p><p>If a new AWS resource is created not via your Terraform file, the state will not be aware of it. This means that resources created via separate Terraform files are independent of each other. If you destroy infrastructure via Terraform, it will not affect any of the other AWS resources not created by your Terraform file and state.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hackit-terraform-templates"></a>HackIT Terraform templates<a class="hash-link" href="#hackit-terraform-templates" title="Direct link to heading">#</a></h2><p>We have three repositories with terraform templates. We use those for all the AWS resources we have identified are required by more than one service. These templates allow developers to simply provide configuration values for their particular instances, based on existing templates.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="common-layer-infrastructure"></a>Common layer infrastructure<a class="hash-link" href="#common-layer-infrastructure" title="Direct link to heading">#</a></h3><p>The ‚Äòcommon layer‚Äô is the infrastructure required to be set up for each account as ‚Äúbase‚Äù infrastructure, including networking, load balancers, database (Postgres, DocumentDB)  and ECS clusters.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="resources"></a>Resources<a class="hash-link" href="#resources" title="Direct link to heading">#</a></h4><ul><li><a href="https://github.com/LBHackney-IT/aws-hackney-common-terraform" target="_blank" rel="noopener noreferrer">GitHub repository</a></li><li><a href="https://docs.google.com/document/d/1Wwj0HTBuSPjQ0ym9dtnGc7pM4x4cfA7OsAbr4YVnsWI/edit#heading=h.553ntygln9sl" target="_blank" rel="noopener noreferrer">Detailed guide on how to use it, including screenshots and step-by-step instructions</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="components-per-service-layer-infrastructure"></a>Components per service layer infrastructure<a class="hash-link" href="#components-per-service-layer-infrastructure" title="Direct link to heading">#</a></h3><p>The components per service layer is all cloud resources that need to be created for any new Fargate/EC2 hosted API/app that is to be deployed.</p><p>For example, the template will create an ECS service, ECR repo, load balancer listener, security group and target group from developer supplied input values.. Those resources will be solely used for the API/app that to be deployed. They are independent of other APIs/apps and if they are destroyed or modified, they will not affect resources of any other API/app running.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="resources-1"></a>Resources<a class="hash-link" href="#resources-1" title="Direct link to heading">#</a></h4><ul><li><a href="https://github.com/LBHackney-IT/aws-hackney-components-per-service-terraform" target="_blank" rel="noopener noreferrer">GitHub repository</a></li><li><a href="https://docs.google.com/document/d/1Wwj0HTBuSPjQ0ym9dtnGc7pM4x4cfA7OsAbr4YVnsWI/edit#heading=h.bbczall7icfy" target="_blank" rel="noopener noreferrer">Detailed guide on how to use it, including screenshots and step-by-step instructions</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dms-terraform"></a>DMS Terraform<a class="hash-link" href="#dms-terraform" title="Direct link to heading">#</a></h3><p>DMS is used by many of the platform APIs that require a data migration task and instance to be set up so data can be migrated from on-premise to our cloud environment.</p><p>The template includes set up for both:</p><p>DMS task, when there is an existing DMS instance</p><p>DMS task and instance provisioning (full set up)</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="resources-2"></a>Resources<a class="hash-link" href="#resources-2" title="Direct link to heading">#</a></h4><ul><li><a href="https://github.com/LBHackney-IT/aws-dms-terraform" target="_blank" rel="noopener noreferrer">How to use notes, including example usage file</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="lambda-apis-deployment"></a>Lambda APIs deployment<a class="hash-link" href="#lambda-apis-deployment" title="Direct link to heading">#</a></h2><p><strong> <u> More on Lambda APIs </u> </strong></p><p>For any APIs that we have chosen Lambda as a serverless deployment option, we use Serverless as a way to provision the necessary resources:</p><ul><li><p>Lambda functions</p></li><li><p>CloudWatch logs</p></li><li><p>IAM roles</p></li><li><p>API Gateway, including usage plan and keys</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment-per-environment-for-apisapps"></a>Deployment per environment for APIs/apps<a class="hash-link" href="#deployment-per-environment-for-apisapps" title="Direct link to heading">#</a></h2><p>Each API/app is to maintain its own infrastructure. This is achieved by adding the Terraform files to the respective API/app repository.</p><p>To support deployment per environment in multiple AWS accounts, the following folder structure has been introduced:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">API/app repo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">‚îú‚îÄ‚îÄ </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">‚îî‚îÄ‚îÄ terraform</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ‚îú‚îÄ‚îÄ development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ‚îÇ   ‚îî‚îÄ‚îÄ main.tf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ‚îú‚îÄ‚îÄ production</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ‚îÇ   ‚îî‚îÄ‚îÄ main.tf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ‚îî‚îÄ‚îÄ staging</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ‚îî‚îÄ‚îÄ main.tf</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In this way, we have individual Terraform files for each AWS account (environment) we are deploying, ensuring that separate states and configurations are maintained.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment-using-circleci"></a>Deployment using CircleCI<a class="hash-link" href="#deployment-using-circleci" title="Direct link to heading">#</a></h2><p>The existing CircleCI pipeline has been set to generate AWS credentials per environment (account) based on the pipeline workflow step. For each account we deploy to, the pipeline is configured to look at the respective folder path
(e.g. <code>terraform/development/main.tf</code>).</p><p>Each time a deployment occurs, terraform initializes the modules specified within the given main.tf and runs <code>apply</code>.</p><p>Note: <code>terraform apply -auto-approve</code> is a command used to force apply (without being presented a confirmation question), which is required to achieve automation.</p><p><a href="https://docs.google.com/document/d/1Wwj0HTBuSPjQ0ym9dtnGc7pM4x4cfA7OsAbr4YVnsWI/edit#heading=h.1q32ztqxg199" target="_blank" rel="noopener noreferrer">More details</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-to-apply-terraform-manually"></a>How to apply Terraform manually<a class="hash-link" href="#how-to-apply-terraform-manually" title="Direct link to heading">#</a></h2><p>In some cases, we don‚Äôt have a pipeline set up to automatically apply the Terraform configuration for us.
In this case, we need to run ‚Äúapply‚Äù manually.</p><p>For example, our individual AWS account network set up is currently applied manually with no pipeline. In comparison, all Terraform resources maintained by the individual APIs/apps are applied using a CI/CD pipeline.</p><p><a href="https://docs.google.com/document/d/1Wwj0HTBuSPjQ0ym9dtnGc7pM4x4cfA7OsAbr4YVnsWI/edit#heading=h.pdxhd5fuwdpm" target="_blank" rel="noopener noreferrer">More information and guide</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-to-find-what-has-been-applied-in-our-aws-accounts-non-api-specific-terraform"></a>How to find what has been applied in our AWS accounts (non API specific Terraform)<a class="hash-link" href="#how-to-find-what-has-been-applied-in-our-aws-accounts-non-api-specific-terraform" title="Direct link to heading">#</a></h2><p>The networking set up and other shared resources have been created via our <a href="https://github.com/LBHackney-IT/aws-hackney-common-terraform/tree/master/applied_terraform" target="_blank" rel="noopener noreferrer">‚Äòcommon Terraform‚Äô template repository</a>. Every time someone makes a change a new PR needs to be created against this repository.</p><p>This ensures that although there is a state file, developers will be able to see the configuration files of what has been applied and make changes to it, while being aware of what has previously been provisioned.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook/edit/master/docs/infrastructure.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-infrastucture-as-code-iac" class="table-of-contents__link">What is Infrastucture as Code (IaC)?</a></li><li><a href="#introduction-to-terraform" class="table-of-contents__link">Introduction to Terraform</a><ul><li><a href="#video-tutorial" class="table-of-contents__link">Video Tutorial</a></li><li><a href="#what-is-a-terraform-state-file" class="table-of-contents__link">What is a Terraform state file?</a></li></ul></li><li><a href="#hackit-terraform-templates" class="table-of-contents__link">HackIT Terraform templates</a><ul><li><a href="#common-layer-infrastructure" class="table-of-contents__link">Common layer infrastructure</a></li><li><a href="#components-per-service-layer-infrastructure" class="table-of-contents__link">Components per service layer infrastructure</a></li><li><a href="#dms-terraform" class="table-of-contents__link">DMS Terraform</a></li></ul></li><li><a href="#lambda-apis-deployment" class="table-of-contents__link">Lambda APIs deployment</a></li><li><a href="#deployment-per-environment-for-apisapps" class="table-of-contents__link">Deployment per environment for APIs/apps</a></li><li><a href="#deployment-using-circleci" class="table-of-contents__link">Deployment using CircleCI</a></li><li><a href="#how-to-apply-terraform-manually" class="table-of-contents__link">How to apply Terraform manually</a></li><li><a href="#how-to-find-what-has-been-applied-in-our-aws-accounts-non-api-specific-terraform" class="table-of-contents__link">How to find what has been applied in our AWS accounts (non API specific Terraform)</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Made by HackIT.</div></div></div></footer></div>
<script src="/Infrastructure-Playbook/styles.7299e51b.js"></script>
<script src="/Infrastructure-Playbook/runtime~main.58b5ab71.js"></script>
<script src="/Infrastructure-Playbook/main.5b7a4e19.js"></script>
<script src="/Infrastructure-Playbook/1.e9c46241.js"></script>
<script src="/Infrastructure-Playbook/2.316fd6e7.js"></script>
<script src="/Infrastructure-Playbook/65.f167685d.js"></script>
<script src="/Infrastructure-Playbook/68.c087ac3c.js"></script>
<script src="/Infrastructure-Playbook/935f2afb.7c354906.js"></script>
<script src="/Infrastructure-Playbook/17896441.40891053.js"></script>
<script src="/Infrastructure-Playbook/f1db5c92.a78ded2b.js"></script>
</body>
</html>