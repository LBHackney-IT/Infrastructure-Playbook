<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/Infrastructure-Playbook/blog/rss.xml" title="Hackney Infrastructure Playbook Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Infrastructure-Playbook/blog/atom.xml" title="Hackney Infrastructure Playbook Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Hackney Infrastructure Playbook" href="/Infrastructure-Playbook/opensearch.xml"><title data-react-helmet="true">Request Tracing with AWS XRay | Hackney Infrastructure Playbook</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Request Tracing with AWS XRay | Hackney Infrastructure Playbook"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><meta data-react-helmet="true" property="og:url" content="https://lbhackney-it.github.io/Infrastructure-Playbook/Infrastructure-Playbook/x_ray"><link data-react-helmet="true" rel="shortcut icon" href="/Infrastructure-Playbook/img/favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://lbhackney-it.github.io/Infrastructure-Playbook/Infrastructure-Playbook/x_ray"><link rel="stylesheet" href="/Infrastructure-Playbook/styles.2116970b.css">
<link rel="stylesheet" href="/Infrastructure-Playbook/main.4a16e2e4.css">
<link rel="preload" href="/Infrastructure-Playbook/styles.79c14b36.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/runtime~main.db1da33c.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/main.cce976fb.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/1.70185c52.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/2.547559b9.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/67.3e59262b.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/70.9338f9b9.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/935f2afb.1ccafd65.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/17896441.decf34b9.js" as="script">
<link rel="preload" href="/Infrastructure-Playbook/097b8e99.8cfab124.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/Infrastructure-Playbook/"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Infrastructure Playbook</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/Infrastructure-Playbook/"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Infrastructure-Playbook/img/logo-long.svg" alt="Infrastructure Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Infrastructure Playbook</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Request Tracing with AWS XRay</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>AWS X-Ray is an AWS managed service that provides the functionality to debug and analyze distributed applications.</p><p><strong>Read the <a href="https://docs.aws.amazon.com/xray/latest/devguide/aws-xray.html" target="_blank" rel="noopener noreferrer">AWS documentation</a> for more information!</strong></p><p>X-Ray provides an end-to-end request view - it will show you the full trace for an API invocation, including any other components/services it invokes.</p><p>The tool is used for identifying the root cause to an issue, discovering performance bottlenecks and seeing real-time data regarding high latency requests.</p><p>AWS X-Ray collects logs and makes use of a Service Map to visualize the dependencies and calls to other services made in an API request.</p><p>X-Ray can be used to identify API requests that are currently not monitored by Canaries by comparing the user requests and those made by Canaries. This is useful to identify if any of the implemented API endpoints are currently not monitored for availability.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="video-tutorial"></a>Video Tutorial<a class="hash-link" href="#video-tutorial" title="Direct link to heading">#</a></h3><p><strong>Watch our overview on XRay below:</strong></p><figure class="video-container"><iframe width="100%" src="https://www.youtube.com/embed/wdPm9hho9iw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe></figure><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="types-of-xray-maps"></a>Types of XRay Maps<a class="hash-link" href="#types-of-xray-maps" title="Direct link to heading">#</a></h3><ul><li><p><strong> Service Maps </strong> - End-to-end visual representation for all dependencies of an application that serves requests</p></li><li><p><strong> Trace Maps </strong> - Individual end-to-end visual representation for a single request</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="benefits-of-aws-x-ray"></a>Benefits of AWS X-Ray<a class="hash-link" href="#benefits-of-aws-x-ray" title="Direct link to heading">#</a></h2><ul><li><p>Provides a way to collect logs and metrics, for all services an API integrates with, including databases or other APIs;</p></li><li><p>Visualizes the collected data for easy analysis of the data to help identify bottlenecks, error root causes and performance issues.</p></li><li><p>Aids the debugging process when an issue occurs, as it gives a developer a way to quickly pinpoint underlying services causing the issue</p><ul><li><p>For example, if an API â€˜Aâ€™ makes a call to another API â€˜Bâ€™, X-Ray service map will help quickly identify which API is causing the issue so the developer can focus their efforts there.</p></li><li><p>If API â€˜Bâ€™ is the cause, X-Ray also provides trace maps, to show the end-to-end request for API â€˜Bâ€™, providing insights into its dependencies to further narrow down the cause</p></li><li><p>In comparison, if a developer did not have access to X-Ray, they will have to:</p><ul><li>Look through application logs</li><li>Identify the line of code causing the error</li><li>See which dependency this error is related to</li><li>Identify logs related to the dependency and go through the process of identifying root cause or possible further dependencies that need to be considered</li></ul></li><li><p>In summary, the process will take longer as developers will have to go through multiple steps and logs in order to narrow down the cause, which results in more development time spent on debugging, instead of resolving the issue.</p></li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-to-enable-and-use-x-ray-in-our-apis"></a>How to enable and use X-Ray in our APIs<a class="hash-link" href="#how-to-enable-and-use-x-ray-in-our-apis" title="Direct link to heading">#</a></h2><p>Serverless can be used to automatically enable X-Ray on our APIs.</p><p><strong><a href="https://www.serverless.com/framework/docs/providers/aws/guide/functions/#aws-x-ray-tracing/" target="_blank" rel="noopener noreferrer">How to enable X-Ray tracing</a></strong></p><p>This will enable it within Lambda and grant it the necessary IAM permissions</p><p>X-Ray needs additional C# configuration to capture metadata and trace downstream calls
Enable C# tracing when using AWS Lambda</p><p><strong><a href="https://docs.aws.amazon.com/lambda/latest/dg/csharp-tracing.html" target="_blank" rel="noopener noreferrer">Instrumenting C# code in AWS Lambda</a></strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="x-ray-with-postgres"></a>X-Ray with Postgres<a class="hash-link" href="#x-ray-with-postgres" title="Direct link to heading">#</a></h2><p>X-Ray can be enabled for Postgres to trace down to the database query level.</p><p><a href="https://net-immersionday.workshop.aws/6-using-x-ray-in-dotnet-application/8-entity-framework-tracing.html" target="_blank" rel="noopener noreferrer"><strong> How to enable X-Ray for a postgres database </strong></a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="x-ray-with-api-gateway"></a>X-Ray with API Gateway<a class="hash-link" href="#x-ray-with-api-gateway" title="Direct link to heading">#</a></h2><p>X-Ray can also be enabled for API Gateway to provide tracing for calls starting at API Gateway.</p><p>For all of our APIs, we use API Gateway to expose them for consumption.</p><p>X-Ray will provide a trace of requests from the moment an API is invoked at API Gateway level to all services the requests travel to.</p><p>We use a custom Lambda authorizer, so enabling X-Ray at API Gateway will provide an easy way to identify if an issue has occurred at API level or during the authorization step.</p><p>The logging and tracing can be customized to only sample requests containing a certain header value and similar.</p><p><a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-services-apigateway.html" target="_blank" rel="noopener noreferrer"><strong>How to enable X-Ray for API Gateway</strong></a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="x-ray-cost"></a>X-Ray cost<a class="hash-link" href="#x-ray-cost" title="Direct link to heading">#</a></h3><p>The first 100,000 traces recorded each month are free.
The first 1,000,000 traces retrieved or scanned each month are free.</p><p><strong>Beyond free tier:</strong></p><p>Traces recorded cost $5.00 per 1 million traces recorded ($0.000005 per trace).
Traces retrieved cost $0.50 per 1 million traces retrieved ($0.0000005 per trace).
Traces scanned cost $0.50 per 1 million traces scanned ($0.0000005 per trace).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="define-metrics-for-alerts"></a>Define Metrics for Alerts<a class="hash-link" href="#define-metrics-for-alerts" title="Direct link to heading">#</a></h2><p>What metrics can be used to trigger alerts, eg, how many exceptions within a defined period.  A one size fit for metrics may not be suitable for all applications.</p><p><strong> Front end logging: </strong></p><p> How can we ship front end logs back to a central logging repository?</p><p><a href="https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-nodejs-configuration.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-nodejs-configuration.html</a></p><p> <a href="https://docs.aws.amazon.com/xray/latest/devguide/scorekeep-client.html" target="_blank" rel="noopener noreferrer"><strong>X-ray js</strong></a></p><p> <strong> Dashboard: </strong></p><p>Service Lens can be used for a consolidated view of insights</p><p>We want to be able to be proactive in responding to alerts/issues.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/LBHackney-IT/Infrastructure-Playbook/edit/master/docs/x_ray.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a><ul><li><a href="#video-tutorial" class="table-of-contents__link">Video Tutorial</a></li><li><a href="#types-of-xray-maps" class="table-of-contents__link">Types of XRay Maps</a></li></ul></li><li><a href="#benefits-of-aws-x-ray" class="table-of-contents__link">Benefits of AWS X-Ray</a></li><li><a href="#how-to-enable-and-use-x-ray-in-our-apis" class="table-of-contents__link">How to enable and use X-Ray in our APIs</a></li><li><a href="#x-ray-with-postgres" class="table-of-contents__link">X-Ray with Postgres</a></li><li><a href="#x-ray-with-api-gateway" class="table-of-contents__link">X-Ray with API Gateway</a><ul><li><a href="#x-ray-cost" class="table-of-contents__link">X-Ray cost</a></li></ul></li><li><a href="#define-metrics-for-alerts" class="table-of-contents__link">Define Metrics for Alerts</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Made by HackIT.</div></div></div></footer></div>
<script src="/Infrastructure-Playbook/styles.79c14b36.js"></script>
<script src="/Infrastructure-Playbook/runtime~main.db1da33c.js"></script>
<script src="/Infrastructure-Playbook/main.cce976fb.js"></script>
<script src="/Infrastructure-Playbook/1.70185c52.js"></script>
<script src="/Infrastructure-Playbook/2.547559b9.js"></script>
<script src="/Infrastructure-Playbook/67.3e59262b.js"></script>
<script src="/Infrastructure-Playbook/70.9338f9b9.js"></script>
<script src="/Infrastructure-Playbook/935f2afb.1ccafd65.js"></script>
<script src="/Infrastructure-Playbook/17896441.decf34b9.js"></script>
<script src="/Infrastructure-Playbook/097b8e99.8cfab124.js"></script>
</body>
</html>